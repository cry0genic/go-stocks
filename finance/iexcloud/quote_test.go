package iexcloud

import (
	"bytes"
	"encoding/json"
	"testing"
)

func TestBatchQuotesUnmarshalJSON(t *testing.T) {
	t.Parallel()

	for i, q := range []string{quoteClosed, quoteOpen} {
		b := make(batchQuotes)
		err := json.NewDecoder(bytes.NewBufferString(q)).Decode(&b)
		if err != nil {
			t.Errorf("%d: %v", i, err)
			continue
		}

		_, err = b.MarshalQuotes()
		if err != nil {
			t.Errorf("%d: %v", i, err)
			continue
		}
	}

}

func TestBatchQuotesMalformedJSON(t *testing.T) {
	t.Parallel()

	b := make(batchQuotes)
	err := json.NewDecoder(bytes.NewBufferString(malformedQuote)).Decode(&b)
	if err != nil {
		t.Fatal(err)
	}

	_, err = b.MarshalQuotes()
	if err == nil {
		t.Fatal("malformed JSON was decoded and successfully marshaled")
	}
}

var (
	quoteClosed = `
{
  "FB": {
    "quote": {
      "symbol": "FB",
      "companyName": "Facebook Inc - Class A",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "close",
      "open": 330.1,
      "openTime": 1619703002048,
      "openSource": "official",
      "close": 329.51,
      "closeTime": 1619726400376,
      "closeSource": "official",
      "high": 331.81,
      "highTime": 1619726399999,
      "highSource": "15 minute delayed price",
      "low": 321.61,
      "lowTime": 1619706949841,
      "lowSource": "15 minute delayed price",
      "latestPrice": 329.51,
      "latestSource": "Close",
      "latestTime": "April 29, 2021",
      "latestUpdate": 1619726400376,
      "latestVolume": 56526771,
      "iexRealtimePrice": 329.49,
      "iexRealtimeSize": 100,
      "iexLastUpdated": 1619726399748,
      "delayedPrice": 329.52,
      "delayedPriceTime": 1619726399970,
      "oddLotDelayedPrice": 329.57,
      "oddLotDelayedPriceTime": 1619726399999,
      "extendedPrice": 327.8,
      "extendedChange": -1.71,
      "extendedChangePercent": -0.00519,
      "extendedPriceTime": 1619740797095,
      "previousClose": 307.1,
      "previousVolume": 33907210,
      "change": 22.41,
      "changePercent": 0.07297,
      "volume": 56526771,
      "iexMarketPercent": 0.027848609997553196,
      "iexVolume": 1574192,
      "avgTotalVolume": 17895968,
      "iexBidPrice": 0,
      "iexBidSize": 0,
      "iexAskPrice": 0,
      "iexAskSize": 0,
      "iexOpen": 329.575,
      "iexOpenTime": 1619726391103,
      "iexClose": 329.49,
      "iexCloseTime": 1619726399748,
      "marketCap": 940421582177,
      "peRatio": 32.66,
      "week52High": 331.81,
      "week52Low": 198.76,
      "ytdChange": 0.19721952408844623,
      "lastTradeTime": 1619726399970,
      "isUSMarketOpen": false
    }
  },
  "AMZN": {
    "quote": {
      "symbol": "AMZN",
      "companyName": "Amazon.com Inc.",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "close",
      "open": 3506.8,
      "openTime": 1619703001660,
      "openSource": "official",
      "close": 3471.31,
      "closeTime": 1619726400630,
      "closeSource": "official",
      "high": 3514.445,
      "highTime": 1619726399964,
      "highSource": "15 minute delayed price",
      "low": 3435,
      "lowTime": 1619712578526,
      "lowSource": "15 minute delayed price",
      "latestPrice": 3471.31,
      "latestSource": "Close",
      "latestTime": "April 29, 2021",
      "latestUpdate": 1619726400630,
      "latestVolume": 7682381,
      "iexRealtimePrice": 3631,
      "iexRealtimeSize": 6,
      "iexLastUpdated": 1619726574232,
      "delayedPrice": 3471.31,
      "delayedPriceTime": 1619726399230,
      "oddLotDelayedPrice": 3472.4,
      "oddLotDelayedPriceTime": 1619726399963,
      "extendedPrice": 3554,
      "extendedChange": 82.69,
      "extendedChangePercent": 0.02382,
      "extendedPriceTime": 1619740799340,
      "previousClose": 3458.5,
      "previousVolume": 4631884,
      "change": 12.81,
      "changePercent": 0.0037,
      "volume": 7682381,
      "iexMarketPercent": 0.03549134051018818,
      "iexVolume": 272658,
      "avgTotalVolume": 3262287,
      "iexBidPrice": 0,
      "iexBidSize": 0,
      "iexAskPrice": 3589.57,
      "iexAskSize": 200,
      "iexOpen": 3631,
      "iexOpenTime": 1619726574232,
      "iexClose": 3471.99,
      "iexCloseTime": 1619726398987,
      "marketCap": 1749945102357,
      "peRatio": 82.99,
      "week52High": 3552.25,
      "week52Low": 2256.38,
      "ytdChange": 0.06558957085353385,
      "lastTradeTime": 1619726399230,
      "isUSMarketOpen": false
    }
  },
  "AAPL": {
    "quote": {
      "symbol": "AAPL",
      "companyName": "Apple Inc",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "close",
      "open": 136.54,
      "openTime": 1619703000384,
      "openSource": "official",
      "close": 133.48,
      "closeTime": 1619726400568,
      "closeSource": "official",
      "high": 137.07,
      "highTime": 1619726399979,
      "highSource": "15 minute delayed price",
      "low": 132.45,
      "lowTime": 1619713017079,
      "lowSource": "15 minute delayed price",
      "latestPrice": 133.48,
      "latestSource": "Close",
      "latestTime": "April 29, 2021",
      "latestUpdate": 1619726400568,
      "latestVolume": 151100953,
      "iexRealtimePrice": 132.94,
      "iexRealtimeSize": 50,
      "iexLastUpdated": 1619729157162,
      "delayedPrice": 133.48,
      "delayedPriceTime": 1619726399978,
      "oddLotDelayedPrice": 133.48,
      "oddLotDelayedPriceTime": 1619726399970,
      "extendedPrice": 132.68,
      "extendedChange": -0.8,
      "extendedChangePercent": -0.00599,
      "extendedPriceTime": 1619740788621,
      "previousClose": 133.58,
      "previousVolume": 107760097,
      "change": -0.1,
      "changePercent": -0.00075,
      "volume": 151100953,
      "iexMarketPercent": 0.017834315048959354,
      "iexVolume": 2694782,
      "avgTotalVolume": 87367005,
      "iexBidPrice": 0,
      "iexBidSize": 0,
      "iexAskPrice": 0,
      "iexAskSize": 0,
      "iexOpen": 132.94,
      "iexOpenTime": 1619729157162,
      "iexClose": 133.47,
      "iexCloseTime": 1619726398584,
      "marketCap": 2240875054080,
      "peRatio": 36.27,
      "week52High": 144.87,
      "week52Low": 70.91,
      "ytdChange": 0.007461816562509578,
      "lastTradeTime": 1619726399979,
      "isUSMarketOpen": false
    }
  },
  "NFLX": {
    "quote": {
      "symbol": "NFLX",
      "companyName": "NetFlix Inc",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "close",
      "open": 507.6,
      "openTime": 1619703001365,
      "openSource": "official",
      "close": 509,
      "closeTime": 1619726400830,
      "closeSource": "official",
      "high": 509.29,
      "highTime": 1619726399991,
      "highSource": "15 minute delayed price",
      "low": 499,
      "lowTime": 1619710506469,
      "lowSource": "15 minute delayed price",
      "latestPrice": 509,
      "latestSource": "Close",
      "latestTime": "April 29, 2021",
      "latestUpdate": 1619726400830,
      "latestVolume": 5127792,
      "iexRealtimePrice": 509.06,
      "iexRealtimeSize": 30,
      "iexLastUpdated": 1619726398746,
      "delayedPrice": 509.05,
      "delayedPriceTime": 1619726399970,
      "oddLotDelayedPrice": 509.01,
      "oddLotDelayedPriceTime": 1619726399991,
      "extendedPrice": 507.5,
      "extendedChange": -1.5,
      "extendedChangePercent": -0.00295,
      "extendedPriceTime": 1619740790276,
      "previousClose": 506.52,
      "previousVolume": 3192983,
      "change": 2.48,
      "changePercent": 0.0049,
      "volume": 5127792,
      "iexMarketPercent": 0.06158225606654872,
      "iexVolume": 315781,
      "avgTotalVolume": 5277127,
      "iexBidPrice": 478,
      "iexBidSize": 125530,
      "iexAskPrice": 0,
      "iexAskSize": 0,
      "iexOpen": 509.06,
      "iexOpenTime": 1619726398746,
      "iexClose": 509.06,
      "iexCloseTime": 1619726398746,
      "marketCap": 224873659072,
      "peRatio": 61.62,
      "week52High": 593.29,
      "week52Low": 397.86,
      "ytdChange": -0.058366325153033874,
      "lastTradeTime": 1619726399970,
      "isUSMarketOpen": false
    }
  },
  "GOOG": {
    "quote": {
      "symbol": "GOOG",
      "companyName": "Alphabet Inc - Class C",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "close",
      "open": 2410.33,
      "openTime": 1619703000203,
      "openSource": "official",
      "close": 2429.89,
      "closeTime": 1619726400449,
      "closeSource": "official",
      "high": 2436.52,
      "highTime": 1619726399997,
      "highSource": "15 minute delayed price",
      "low": 2402.28,
      "lowTime": 1619703000636,
      "lowSource": "15 minute delayed price",
      "latestPrice": 2429.89,
      "latestSource": "Close",
      "latestTime": "April 29, 2021",
      "latestUpdate": 1619726400449,
      "latestVolume": 1977677,
      "iexRealtimePrice": 2429.72,
      "iexRealtimeSize": 1,
      "iexLastUpdated": 1619726390714,
      "delayedPrice": 2429.89,
      "delayedPriceTime": 1619726399903,
      "oddLotDelayedPrice": 2429.88,
      "oddLotDelayedPriceTime": 1619726399997,
      "extendedPrice": 2415,
      "extendedChange": -14.89,
      "extendedChangePercent": -0.00613,
      "extendedPriceTime": 1619740797154,
      "previousClose": 2379.91,
      "previousVolume": 2986439,
      "change": 49.98,
      "changePercent": 0.021,
      "volume": 1977677,
      "iexMarketPercent": 0.045635359060149865,
      "iexVolume": 90252,
      "avgTotalVolume": 1412610,
      "iexBidPrice": 0,
      "iexBidSize": 0,
      "iexAskPrice": 0,
      "iexAskSize": 0,
      "iexOpen": 2428.92,
      "iexOpenTime": 1619726386118,
      "iexClose": 2429.72,
      "iexCloseTime": 1619726390714,
      "marketCap": 1632592024934,
      "peRatio": null,
      "week52High": 2452.38,
      "week52Low": 1299,
      "ytdChange": 0.3794891659246066,
      "lastTradeTime": 1619726399903,
      "isUSMarketOpen": false
    }
  }
}`

	quoteOpen = `
{
  "AMZN": {
    "quote": {
      "symbol": "AMZN",
      "companyName": "Amazon.com Inc.",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "tops",
      "open": null,
      "openTime": null,
      "openSource": "official",
      "close": null,
      "closeTime": null,
      "closeSource": "official",
      "high": null,
      "highTime": 1619791304710,
      "highSource": "IEX real time price",
      "low": null,
      "lowTime": null,
      "lowSource": null,
      "latestPrice": 3539.455,
      "latestSource": "IEX real time price",
      "latestTime": "10:03:33 AM",
      "latestUpdate": 1619791413494,
      "latestVolume": null,
      "iexRealtimePrice": 3539.455,
      "iexRealtimeSize": 1,
      "iexLastUpdated": 1619791413494,
      "delayedPrice": null,
      "delayedPriceTime": null,
      "oddLotDelayedPrice": null,
      "oddLotDelayedPriceTime": null,
      "extendedPrice": null,
      "extendedChange": null,
      "extendedChangePercent": null,
      "extendedPriceTime": null,
      "previousClose": 3471.31,
      "previousVolume": 7682381,
      "change": 68.145,
      "changePercent": 0.01963,
      "volume": null,
      "iexMarketPercent": 0.04528704153160546,
      "iexVolume": 109436,
      "avgTotalVolume": 3491711,
      "iexBidPrice": 3495,
      "iexBidSize": 161,
      "iexAskPrice": 0,
      "iexAskSize": 0,
      "iexOpen": 3539.16,
      "iexOpenTime": 1619791413472,
      "iexClose": 3539.455,
      "iexCloseTime": 1619791413494,
      "marketCap": 1784298130176,
      "peRatio": 84.62,
      "week52High": 3552.84,
      "week52Low": 2256.38,
      "ytdChange": 0.08545272262529433,
      "lastTradeTime": 1619791413494,
      "isUSMarketOpen": true
    }
  },
  "AAPL": {
    "quote": {
      "symbol": "AAPL",
      "companyName": "Apple Inc",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "tops",
      "open": null,
      "openTime": null,
      "openSource": "official",
      "close": null,
      "closeTime": null,
      "closeSource": "official",
      "high": null,
      "highTime": 1619791192909,
      "highSource": "IEX real time price",
      "low": null,
      "lowTime": null,
      "lowSource": null,
      "latestPrice": 132.695,
      "latestSource": "IEX real time price",
      "latestTime": "10:03:33 AM",
      "latestUpdate": 1619791413349,
      "latestVolume": null,
      "iexRealtimePrice": 132.695,
      "iexRealtimeSize": 4,
      "iexLastUpdated": 1619791413349,
      "delayedPrice": null,
      "delayedPriceTime": null,
      "oddLotDelayedPrice": null,
      "oddLotDelayedPriceTime": null,
      "extendedPrice": null,
      "extendedChange": null,
      "extendedChangePercent": null,
      "extendedPriceTime": null,
      "previousClose": 133.48,
      "previousVolume": 151100953,
      "change": -0.785,
      "changePercent": -0.00588,
      "volume": null,
      "iexMarketPercent": 0.014358459978855964,
      "iexVolume": 221366,
      "avgTotalVolume": 89005861,
      "iexBidPrice": 129,
      "iexBidSize": 165,
      "iexAskPrice": 132.7,
      "iexAskSize": 100,
      "iexOpen": 132.695,
      "iexOpenTime": 1619791413349,
      "iexClose": 132.695,
      "iexCloseTime": 1619791413349,
      "marketCap": 2227696398720,
      "peRatio": 36.06,
      "week52High": 144.87,
      "week52Low": 70.91,
      "ytdChange": 0.0015770540108080953,
      "lastTradeTime": 1619791413349,
      "isUSMarketOpen": true
    }
  },
  "FB": {
    "quote": {
      "symbol": "FB",
      "companyName": "Facebook Inc - Class A",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "tops",
      "open": null,
      "openTime": null,
      "openSource": "official",
      "close": null,
      "closeTime": null,
      "closeSource": "official",
      "high": null,
      "highTime": null,
      "highSource": null,
      "low": null,
      "lowTime": null,
      "lowSource": null,
      "latestPrice": 328.71,
      "latestSource": "IEX real time price",
      "latestTime": "10:03:31 AM",
      "latestUpdate": 1619791411927,
      "latestVolume": null,
      "iexRealtimePrice": 328.71,
      "iexRealtimeSize": 37,
      "iexLastUpdated": 1619791411927,
      "delayedPrice": null,
      "delayedPriceTime": null,
      "oddLotDelayedPrice": null,
      "oddLotDelayedPriceTime": null,
      "extendedPrice": null,
      "extendedChange": null,
      "extendedChangePercent": null,
      "extendedPriceTime": null,
      "previousClose": 329.51,
      "previousVolume": 56526771,
      "change": -0.8,
      "changePercent": -0.00243,
      "volume": null,
      "iexMarketPercent": 0.02800405438704754,
      "iexVolume": 145353,
      "avgTotalVolume": 19747399,
      "iexBidPrice": 320,
      "iexBidSize": 300,
      "iexAskPrice": 328.8,
      "iexAskSize": 100,
      "iexOpen": 328.72,
      "iexOpenTime": 1619791411377,
      "iexClose": 328.72,
      "iexCloseTime": 1619791411927,
      "marketCap": 938138382075,
      "peRatio": 32.58,
      "week52High": 331.81,
      "week52Low": 198.76,
      "ytdChange": 0.20385935422463003,
      "lastTradeTime": 1619791411927,
      "isUSMarketOpen": true
    }
  },
  "NFLX": {
    "quote": {
      "symbol": "NFLX",
      "companyName": "NetFlix Inc",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "tops",
      "open": null,
      "openTime": null,
      "openSource": "official",
      "close": null,
      "closeTime": null,
      "closeSource": "official",
      "high": null,
      "highTime": null,
      "highSource": null,
      "low": null,
      "lowTime": null,
      "lowSource": null,
      "latestPrice": 508.81,
      "latestSource": "IEX real time price",
      "latestTime": "10:03:28 AM",
      "latestUpdate": 1619791408157,
      "latestVolume": null,
      "iexRealtimePrice": 508.81,
      "iexRealtimeSize": 100,
      "iexLastUpdated": 1619791408157,
      "delayedPrice": null,
      "delayedPriceTime": null,
      "oddLotDelayedPrice": null,
      "oddLotDelayedPriceTime": null,
      "extendedPrice": null,
      "extendedChange": null,
      "extendedChangePercent": null,
      "extendedPriceTime": null,
      "previousClose": 509,
      "previousVolume": 5127792,
      "change": -0.19,
      "changePercent": -0.00037,
      "volume": null,
      "iexMarketPercent": 0.0408343824369249,
      "iexVolume": 24554,
      "avgTotalVolume": 5358361,
      "iexBidPrice": 505.71,
      "iexBidSize": 101,
      "iexAskPrice": 512,
      "iexAskSize": 200,
      "iexOpen": 508.81,
      "iexOpenTime": 1619791408157,
      "iexClose": 508.81,
      "iexCloseTime": 1619791408157,
      "marketCap": 224789718020,
      "peRatio": 61.6,
      "week52High": 593.29,
      "week52Low": 397.86,
      "ytdChange": -0.059049932683594396,
      "lastTradeTime": 1619791408157,
      "isUSMarketOpen": true
    }
  },
  "GOOG": {
    "quote": {
      "symbol": "GOOG",
      "companyName": "Alphabet Inc - Class C",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "tops",
      "open": null,
      "openTime": null,
      "openSource": "official",
      "close": null,
      "closeTime": null,
      "closeSource": "official",
      "high": null,
      "highTime": 1619791399976,
      "highSource": "IEX real time price",
      "low": null,
      "lowTime": 1619789837926,
      "lowSource": "IEX real time price",
      "latestPrice": 2424.86,
      "latestSource": "IEX real time price",
      "latestTime": "10:03:28 AM",
      "latestUpdate": 1619791408157,
      "latestVolume": null,
      "iexRealtimePrice": 2424.86,
      "iexRealtimeSize": 200,
      "iexLastUpdated": 1619791408157,
      "delayedPrice": null,
      "delayedPriceTime": null,
      "oddLotDelayedPrice": null,
      "oddLotDelayedPriceTime": null,
      "extendedPrice": null,
      "extendedChange": null,
      "extendedChangePercent": null,
      "extendedPriceTime": null,
      "previousClose": 2429.89,
      "previousVolume": 1977677,
      "change": -5.03,
      "changePercent": -0.00207,
      "volume": null,
      "iexMarketPercent": 0.04150749338818689,
      "iexVolume": 15820,
      "avgTotalVolume": 1438497,
      "iexBidPrice": 0,
      "iexBidSize": 0,
      "iexAskPrice": 2426.01,
      "iexAskSize": 100,
      "iexOpen": 2424.86,
      "iexOpenTime": 1619791408157,
      "iexClose": 2424.86,
      "iexCloseTime": 1619791408157,
      "marketCap": 1637195170459,
      "peRatio": null,
      "week52High": 2452.38,
      "week52Low": 1299,
      "ytdChange": 0.38494851725003976,
      "lastTradeTime": 1619791408157,
      "isUSMarketOpen": true
    }
  }
}`

	malformedQuote = `
{
  "FB": {
    "book": {
      "symbol": "FB",
      "companyName": "Facebook Inc - Class A",
      "primaryExchange": "NASDAQ/NGS (GLOBAL SELECT MARKET)",
      "calculationPrice": "close",
      "open": 330.1,
      "openTime": 1619703002048,
      "openSource": "official",
      "close": 329.51,
      "closeTime": 1619726400376,
      "closeSource": "official",
      "high": 331.81,
      "highTime": 1619726399999,
      "highSource": "15 minute delayed price",
      "low": 321.61,
      "lowTime": 1619706949841,
      "lowSource": "15 minute delayed price",
      "latestPrice": 329.51,
      "latestSource": "Close",
      "latestTime": "April 29, 2021",
      "latestUpdate": 1619726400376,
      "latestVolume": 56526771,
      "iexRealtimePrice": 329.49,
      "iexRealtimeSize": 100,
      "iexLastUpdated": 1619726399748,
      "delayedPrice": 329.52,
      "delayedPriceTime": 1619726399970,
      "oddLotDelayedPrice": 329.57,
      "oddLotDelayedPriceTime": 1619726399999,
      "extendedPrice": 327.8,
      "extendedChange": -1.71,
      "extendedChangePercent": -0.00519,
      "extendedPriceTime": 1619740797095,
      "previousClose": 307.1,
      "previousVolume": 33907210,
      "change": 22.41,
      "changePercent": 0.07297,
      "volume": 56526771,
      "iexMarketPercent": 0.027848609997553196,
      "iexVolume": 1574192,
      "avgTotalVolume": 17895968,
      "iexBidPrice": 0,
      "iexBidSize": 0,
      "iexAskPrice": 0,
      "iexAskSize": 0,
      "iexOpen": 329.575,
      "iexOpenTime": 1619726391103,
      "iexClose": 329.49,
      "iexCloseTime": 1619726399748,
      "marketCap": 940421582177,
      "peRatio": 32.66,
      "week52High": 331.81,
      "week52Low": 198.76,
      "ytdChange": 0.19721952408844623,
      "lastTradeTime": 1619726399970,
      "isUSMarketOpen": false
    }
  }
}
`
)
